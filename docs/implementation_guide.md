# JobWorkerp Admin UI Implementation Guide

This document serves as a guide for AI agents and developers to understand the architecture, implementation patterns, and design decisions of the JobWorkerp Admin UI.

## 1. Architecture Overview

The application is a Single Page Application (SPA) built with the following stack:
- **Build Tool**: Vite
- **Framework**: React 19 + TypeScript
- **Styling**: Tailwind CSS v4, shadcn/ui (Radix UI based)
- **API Communication**: gRPC-Web (via `nice-grpc-web`)
- **State Management**: React Query (TanStack Query)
- **Routing**: React Router v7

### Directory Structure

```
admin-ui/
├── public/                 # Static assets (config.js for runtime config)
├── src/
│   ├── components/         # UI Components
│   │   ├── ui/             # shadcn/ui primitive components
│   │   └── dynamic-proto/  # Dynamic form generation from Protobuf schemas
│   ├── hooks/              # Custom hooks (mostly React Query wrappers)
│   ├── lib/                # Core utilities
│   │   ├── client.ts       # gRPC client initialization & config
│   │   └── grpc/           # Generated Protobuf code & definitions
│   ├── pages/              # Application pages (Route handlers)
│   └── test/               # Test utilities
├── docker/                 # Docker configuration resources
└── tests/                  # E2E Tests (Playwright)
```

## 2. Key Implementation Patterns

### 2.1 API Communication (gRPC-Web)
- **Client Factory**: `src/lib/client.ts` initializes the gRPC channel and creates typed clients for each service (Worker, Runner, Job, etc.).
- **Runtime Configuration**: The gRPC endpoint is determined at runtime to allow Docker images to be portable.
    - Local Dev: Reads from `.env` or defaults to localhost.
    - Production/Docker: Reads `window.__RUNTIME_CONFIG__` injected by `config.js` (generated by `docker/env.sh`).
    - **Pattern**: `window.__RUNTIME_CONFIG__?.VITE_GRPC_ENDPOINT || import.meta.env.VITE_GRPC_ENDPOINT`

### 2.2 Data Fetching (React Query)
- **Hook Pattern**: Data fetching logic is encapsulated in custom hooks within `src/hooks/`.
- **Naming**: `use<Resource>Metrics`, `use<Resource>List`, `use<Resource>Actions`.
- **Example**: `useWorkers` provides `useWorkerList` (Query) and `useCreateWorker` (Mutation).
- **Error Handling**: Standard React Query `error` and `isLoading` states are used.

### 2.3 Dynamic Forms (Protobuf Integration)
- **Problem**: Enqueueing a job requires arguments that vary based on the Runner's Protobuf definition.
- **Solution**: `DynamicProtoForm` (`src/components/dynamic-proto/`)
    - **Functionality**: Parses the Protobuf schema JSON (provided by the backend Runner API) at runtime.
    - **Rendering**: Recursively renders form fields for Protobuf messages, handling simpler types (string, int) and complex types (nested messages, repeated fields, oneof).
    - **Validation**: Basic type validation and compatibility checks (e.g., verifying Queue and Response types match).

### 2.4 Layout & Navigation
- **AppLayout**: Uses `AppSidebar` (`src/components/app-sidebar.tsx`) for navigation.
- **Responsive**: Built using shadcn/ui's `Sidebar` primitives, handling mobile/desktop views automatically.
- **Routes**: Defined in `src/App.tsx`.

### 2.5 System Administration
- **Pages**: `src/pages/system/index.tsx`
- **Features**:
    - **Stuck Jobs**: Identification and cancellation of jobs that have been running too long.
    - **Cleanup**: Deletion of old job status records.
    - **Restore**: Recovery of jobs from RDB to Redis queue.

## 3. Docker & Deployment

- **Environment Injection**:
    - `docker/env.sh`: Runs on container start (entrypoint). Reads OS environment variables and writes them to a `config.js` file in the web root.
    - `index.html`: Loads `config.js` before the main app bundle.
- **Multi-stage Build**:
    - `builder`: Node.js environment builds the assets (`pnpm build`).
    - `runner`: Nginx Alpine image serves static files and handles the entrypoint script.

## 4. Development Guidelines

- **Linting**: `pnpm lint` (ESLint) - strict rules, no unused vars.
- **Testing**:
    - Unit: `pnpm test` (Vitest) - Mock gRPC clients.
    - E2E: `pnpm exec playwright test` - Full flow testing.
- **Styling**: Use utility classes (Tailwind). Avoid custom CSS files unless invalidating standard behavior.
- **Components**: Prefer composition over inheritance. Use `shadcn/ui` components as the source of truth for design tokens.
